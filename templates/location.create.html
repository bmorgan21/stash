{% extends 'base.html' %}

{% block styles %}
<style type="text/css">
#map-canvas {
  height: 200px;
}

#map-canvas img {
  max-width:inherit !important;
}

</style>
{% endblock %}

{% block header %}
<h1>{% if exists %}Edit{% else %}Create{% endif %} Location</h1>
{% endblock %}

{% block body %}
<form class="form-stacked" method='POST' data-vars='{{ helpers.JSON.stringify(vars) }}' data-errors='{{ helpers.JSON.stringify(errors) }}'>
    <input type="hidden" name="reference"/>
    <input type="hidden" name="phone_number"/>
    <input type="hidden" name="international_phone_number"/>
    <input type="hidden" name="icon"/>
    <input type="hidden" name="photos"/>
    <input type="hidden" name="price_level"/>
    <input type="hidden" name="rating"/>
    <input type="hidden" name="types"/>
    <input type="hidden" name="url"/>
    <input type="hidden" name="website"/>
    <input type="hidden" name="lng"/>
    <input type="hidden" name="lat"/>
    <input type="hidden" name="vicinity"/>
    <input type="hidden" name="viewport"/>
    <div class="control-group">
        <label class="control-label">Location:</label>
        <div class="controls">
            <input id="addressField" autocomplete="off" class="input-block-level" name="address" type="text" placeholder="i.e. 23 Hardy Rd, Londonderry, NH">
            <span class="help-inline" style="display:none;"></span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Name:</label>
        <div class="controls error">
            <input id="nameField" class="input-block-level" name="name" type="text" placeholder="i.e. Home">
            <span class="help-inline" style="display:none;"></span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">Tags:</label>
        <div class="controls error">
            <input type="text" class="input-block-level" name="tag"></input>
            <select class="span2" name="tag_type">
                <option value="text">Text</option>
                <option value="url">Url</option>
                <option value="markdown">Markdown</option>
                <option value="html">Html</option>
            </select>
            <div class="form-element">
                <button class="btn btn-primary btn-small">Add</button>
                <span class="help-inline"></span>
            </div>
        </div>
    </div>
    <div id="map-canvas" class="map"></div>
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Save</button>
        <button type="button" class="btn">Cancel</button>
    </div>
</form>

{% endblock %}

{% block scripts %}
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>

    <script>
function initialize() {
  var mapOptions = {
    zoom: 14,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  var map = new google.maps.Map($('#map-canvas')[0], mapOptions);
  google.maps.event.addListenerOnce(map, 'tilesloaded', function(){
      // do something only the first time the map is loaded
    place_changed(map, marker, $form.values());
  });
  var service = new google.maps.places.PlacesService(map);

  var infowindow = new google.maps.InfoWindow();
  var marker = new google.maps.Marker({
    map: map
  });

  var $name_field = $('#nameField');
  var $form = $name_field.closest('form');
  var $address_field = $('#addressField');
  var options = {
    source:function(query, callback) {
      var request = {
        bounds: map.getBounds(),
        query: query
      };

      service.textSearch(request, function(places, status) {
        window.places = places;
        window.status = status;

        callback($.merge([{'id':null, 'name':query, 'selection':query, formatted_address:''}], $(places).map(function(i, el) {
          return {'id': el.id, 'name': el['name'] + ' - ' + el.formatted_address, 'selection': el['name'] || el.formatted_address, 
                  reference: el.reference};
        })));
      });
    },
    updater: function(json_item) {
            item = JSON.parse(json_item);

            service.getDetails({reference:item.reference}, function(place, status) {
              var values = {}
              values['address'] = place.formatted_address
              values['phone_number'] = place.formatted_phone_number
              values['lat'] = place.geometry.location.lat()
              values['lng'] = place.geometry.location.lng()
              values['viewport'] = place.geometry.viewport
              $form.values($.extend(values, place));

              place_changed(map, marker, $form.values());
              $name_field.focus().select();
            })

            return item['selection'];
    }
  }
  $address_field.typeahead(options);

  if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function(position) {
      var pos = new google.maps.LatLng(position.coords.latitude,
                                       position.coords.longitude);

      map.setCenter(pos);
    }, function() {
      handleNoGeolocation(infowindow, map, true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(infowindow, map, false);
  }
}

function handleNoGeolocation(infowindow, map, errorFlag) {
  if (errorFlag) {
    var content = 'Error: The Geolocation service failed.';
  } else {
    var content = 'Error: Your browser doesn\'t support geolocation.';
  }

  infowindow.setContent(content);
  map.setCenter(new google.maps.LatLng(60, 105));
}

function place_changed(map, marker, vars) {
    if (!(vars.lat || vars.lng)) return

    var location = new google.maps.LatLng(vars.lat, vars.lng);

    // If the place has a geometry, then present it on a map.
    if (vars.viewport) {
      map.fitBounds(vars.viewport);
    } else {
      map.setCenter(location);
      map.setZoom(17);  // Why 17? Because it looks good.
    }
    marker.setIcon(/** @type {google.maps.Icon} */({
      url: vars.icon,
      size: new google.maps.Size(71, 71),
      origin: new google.maps.Point(0, 0),
      anchor: new google.maps.Point(17, 34),
      scaledSize: new google.maps.Size(35, 35)
    }));
    marker.setPosition(location);
    marker.setVisible(true);
}

(function($) {
  initialize()
})(jQuery);

    </script>
{% endblock %}
